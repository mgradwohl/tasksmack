name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate-environment:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm
        with:
          install-clang-format: 'true'
          install-clang-tidy: 'true'
          install-coverage-tools: 'true'

      - name: Validate prerequisites
        run: ./tools/check-prereqs.sh

  build-linux:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    strategy:
      matrix:
        build_type: [debug, release]
    name: Build & Test (Linux ${{ matrix.build_type }})
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-${{ matrix.build_type }}
          max-size: 500M

      - name: Cache FetchContent dependencies
        uses: actions/cache@v5
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-deps-

      - name: Configure
        run: cmake --preset ${{ matrix.build_type }}

      - name: Build
        run: cmake --build --preset ${{ matrix.build_type }}

      - name: Test
        run: ctest --preset ${{ matrix.build_type }} -j $(nproc) --output-on-failure --timeout 60 --output-junit test-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: linux-${{ matrix.build_type }}-test-results
          path: build/${{ matrix.build_type }}/test-results.xml
          retention-days: 30

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 20
    strategy:
      matrix:
        build_type: [debug, release]
    name: Build & Test (Windows ${{ matrix.build_type }})
    steps:
      - uses: actions/checkout@v6

      # Pin the Python that will be used for GLAD (and install jinja2 into it).
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          cache: 'pip'

      - name: Install Python dependencies for GLAD
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install jinja2
          python -c "import sys; print('Python:', sys.executable)"
          python -c "import jinja2; print('jinja2:', jinja2.__version__)"

      - name: Install LLVM / Ninja / ccache
        shell: pwsh
        run: choco install llvm ninja ccache -y

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: windows-${{ matrix.build_type }}
          max-size: 500M

      - name: Cache FetchContent dependencies
        uses: actions/cache@v5
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-deps-

      - name: Configure
        shell: pwsh
        env:
          LLVM_ROOT: C:\Program Files\LLVM
        run: |
          cmake --preset win-${{ matrix.build_type }} -DPython3_EXECUTABLE="$env:pythonLocation\python.exe"

      - name: Build
        shell: pwsh
        env:
          LLVM_ROOT: C:\Program Files\LLVM
        run: cmake --build --preset win-${{ matrix.build_type }}

      - name: Test
        shell: pwsh
        run: ctest --preset win-${{ matrix.build_type }} -j $env:NUMBER_OF_PROCESSORS --output-on-failure --timeout 60 --output-junit test-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: windows-${{ matrix.build_type }}-test-results
          path: build/win-${{ matrix.build_type }}/test-results.xml
          retention-days: 30

  format-check:
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm
        with:
          install-clang-format: 'true'
          install-ninja: 'false'
          install-ccache: 'false'

      - name: Check formatting
        run: ./tools/check-format.sh

  static-analysis:
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm
        with:
          install-clang-tidy: 'true'

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-tidy
          max-size: 500M

      - name: Cache FetchContent dependencies
        uses: actions/cache@v5
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-deps-

      - name: Run clang-tidy
        run: ./tools/clang-tidy.sh debug 2>&1 | tee clang-tidy-output.txt

      - name: Upload clang-tidy results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: clang-tidy-results
          path: clang-tidy-output.txt
          retention-days: 14

  include-analysis:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm

      - name: Install include-what-you-use
        run: |
          sudo apt-get update
          sudo apt-get install -y iwyu

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-iwyu
          max-size: 500M

      - name: Cache FetchContent dependencies
        uses: actions/cache@v5
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-deps-

      - name: Configure (debug preset)
        run: cmake --preset debug

      - name: Build (debug preset)
        run: cmake --build --preset debug

      - name: Run include-what-you-use
        run: ./tools/iwyu.sh --report debug 2>&1 | tee iwyu-output.txt

      - name: Add IWYU summary to workflow summary
        if: always()
        run: |
          echo "## Include-What-You-Use Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify iwyu-output.txt exists and has content before processing
          if [[ ! -f iwyu-output.txt ]] || [[ ! -s iwyu-output.txt ]]; then
            echo "âš ï¸ **Status:** No IWYU output file generated" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Check if IWYU found any issues
          # grep -qE: -q for quiet mode (no output), -E for extended regex
          # Exit codes: 0 = pattern found, 1 = not found, 2 = error (e.g., file I/O or invalid regex).
          if grep -qE "should add these lines:|should remove these lines:" iwyu-output.txt 2>/dev/null; then
            echo "âš ï¸ **Status:** Include suggestions found (advisory)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "(should add|should remove|has correct)" iwyu-output.txt | head -50 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Count unique files with suggestions
            # Expected IWYU line format (per-file summary), e.g.:
            #   path/to/file.cpp should add these lines:
            #   path/to/file.cpp should remove these lines:
            # The sed expression captures the filename (everything before " should add/remove these lines:"),
            # deduplicates filenames, and counts them.
            #
            # Use subshell with pipefail to properly capture pipeline errors
            # (without pipefail, $? only reflects the last command - wc -l - which rarely fails)
            SUGGESTED_FILES=$(set -o pipefail; grep -E "(should add these lines:|should remove these lines:)" iwyu-output.txt 2>/dev/null | sed -E 's/^(.*) should (add|remove) these lines:.*/\1/' | sort -u | wc -l) || PIPELINE_FAILED=true

            # Trim whitespace from wc output (some implementations add leading spaces)
            SUGGESTED_FILES=$(echo "$SUGGESTED_FILES" | tr -d ' ')

            # Check if pipeline failed or output is invalid
            # Note: wc -l always outputs a number, so we only check for pipeline failure and numeric format
            if [[ "${PIPELINE_FAILED:-false}" == "true" ]]; then
              echo "âš ï¸ Warning: Pipeline command failed; falling back to 0 suggested files." >> $GITHUB_STEP_SUMMARY
              SUGGESTED_FILES=0
            elif ! [[ "$SUGGESTED_FILES" =~ ^[0-9]+$ ]]; then
              echo "âš ï¸ Warning: IWYU output format changed or parse error (got: '$SUGGESTED_FILES'); falling back to 0 suggested files." >> $GITHUB_STEP_SUMMARY
              SUGGESTED_FILES=0
            fi

            echo "**Files with suggestions:** $SUGGESTED_FILES" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status:** No include issues found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Full report available in artifacts (retention: 14 days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip:** IWYU suggestions are advisory and context-dependent. Review each suggestion before applying." >> $GITHUB_STEP_SUMMARY

      - name: Upload IWYU results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: iwyu-results
          path: iwyu-output.txt
          retention-days: 14

  coverage:
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm
        with:
          install-coverage-tools: 'true'

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-coverage
          max-size: 500M

      - name: Cache FetchContent dependencies
        uses: actions/cache@v5
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-deps-

      - name: Generate coverage report
        run: |
          ./tools/coverage.sh -v 2>&1 | tee coverage-output.txt

      - name: Add coverage summary to workflow summary
        if: always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage-output.txt ]; then
            echo "### Coverage Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            sed -n '/^Filename/,/^TOTAL/p' coverage-output.txt >> $GITHUB_STEP_SUMMARY || echo "Coverage summary not found in output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Full HTML report available in artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage output file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check coverage threshold
        if: always()
        run: |
          # Extract coverage percentage from llvm-cov output
          # The TOTAL line format is: "TOTAL    NNN    MMM    XX.XX%"
          if [ -f coverage-output.txt ]; then
            COVERAGE=$(grep "^TOTAL" coverage-output.txt | awk '{print $NF}' | sed 's/%//')
            THRESHOLD=80

            echo "ðŸ“Š Current coverage: ${COVERAGE}%"
            echo "ðŸŽ¯ Minimum threshold: ${THRESHOLD}%"

            # Use awk for floating point comparison (bc might not be available)
            if awk "BEGIN {exit !($COVERAGE < $THRESHOLD)}"; then
              echo "âš ï¸  WARNING: Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
              echo "This is a warning only - build will continue"
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Coverage Warning:** Current coverage (${COVERAGE}%) is below the ${THRESHOLD}% threshold" >> $GITHUB_STEP_SUMMARY
              # Don't fail the build, just warn
            else
              echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Coverage Status:** Current coverage (${COVERAGE}%) meets the ${THRESHOLD}% threshold" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage output file not found - cannot check threshold"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Coverage Check Failed:** Could not find coverage output file" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  sanitizers:
    runs-on: ubuntu-24.04
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        preset: [asan-ubsan, tsan]
    steps:
      - uses: actions/checkout@v6

      - name: Setup LLVM
        uses: ./.github/actions/setup-llvm

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-${{ matrix.preset }}
          max-size: 500M

      - name: Cache FetchContent dependencies
        uses: actions/cache@v5
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-deps-

      - name: Configure
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Create output directories
        run: |
          mkdir -p sanitizer-logs
          mkdir -p sanitizer-reports

      - name: Test with sanitizers
        id: sanitizer-test
        continue-on-error: true
        run: |
          ctest --preset ${{ matrix.preset }} -j $(nproc) --output-on-failure --timeout 120 2>&1 | tee sanitizer-logs/${{ matrix.preset }}.log
          echo "test_result=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Annotate sanitizer failures
        if: steps.sanitizer-test.outputs.test_result != '0'
        run: |
          grep -n "ERROR:" sanitizer-logs/${{ matrix.preset }}.log | while IFS=: read -r line content; do
            echo "::error file=sanitizer-logs/${{ matrix.preset }}.log,line=$line::$content"
          done || true

      - name: Generate HTML report
        if: always()
        run: |
          cat > sanitizer-reports/${{ matrix.preset }}.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>${{ matrix.preset }} Sanitizer Report</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                      line-height: 1.6;
                      max-width: 1200px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 30px;
                      border-radius: 8px;
                      margin-bottom: 20px;
                      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  }
                  .header h1 {
                      margin: 0 0 10px 0;
                      font-size: 2em;
                  }
                  .header .timestamp {
                      opacity: 0.9;
                      font-size: 0.9em;
                  }
                  .content {
                      background: white;
                      padding: 30px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  pre {
                      background-color: #1e1e1e;
                      color: #d4d4d4;
                      padding: 20px;
                      border-radius: 6px;
                      overflow-x: auto;
                      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                      font-size: 14px;
                      line-height: 1.5;
                      white-space: pre-wrap;
                      word-wrap: break-word;
                  }
                  .error {
                      color: #f48771;
                      font-weight: bold;
                  }
                  .warning {
                      color: #dcdcaa;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>${{ matrix.preset }} Sanitizer Report</h1>
                  <div class="timestamp">Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</div>
              </div>
              <div class="content">
                  <h2>Test Output</h2>
                  <pre>
          EOF

          if [ -f sanitizer-logs/${{ matrix.preset }}.log ]; then
            sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' sanitizer-logs/${{ matrix.preset }}.log >> sanitizer-reports/${{ matrix.preset }}.html
          else
            echo "No log file found" >> sanitizer-reports/${{ matrix.preset }}.html
          fi

          cat >> sanitizer-reports/${{ matrix.preset }}.html << 'EOF'
                  </pre>
              </div>
          </body>
          </html>
          EOF

      - name: Add sanitizer summary to workflow summary
        if: always()
        run: |
          echo "## ${{ matrix.preset }} Sanitizer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.sanitizer-test.outputs.test_result }}" = "0" ]; then
            echo "âœ… **Status:** PASSED - No issues detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** FAILED - Issues detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Issue Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            if [ -f sanitizer-logs/${{ matrix.preset }}.log ]; then
              grep -E "(ERROR|SUMMARY):" sanitizer-logs/${{ matrix.preset }}.log | head -20 >> $GITHUB_STEP_SUMMARY || echo "No specific error patterns found" >> $GITHUB_STEP_SUMMARY
            fi

            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full report available in artifacts: \`sanitizer-reports/${{ matrix.preset }}.html\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload sanitizer logs and reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.preset }}-report
          path: |
            sanitizer-logs/${{ matrix.preset }}.log
            sanitizer-reports/${{ matrix.preset }}.html
          retention-days: 14

      - name: Fail job if sanitizer found issues
        if: steps.sanitizer-test.outputs.test_result != '0'
        run: |
          echo "Sanitizer detected issues. Failing the job."
          exit 1
